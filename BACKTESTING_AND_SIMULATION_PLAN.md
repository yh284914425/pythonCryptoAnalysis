# 策略回测与模拟交易计划

本文档为 `MultiTimeframeDivergenceStrategy` 提供一个从历史数据回测到实时模拟交易（Paper Trading）的完整验证流程。目标是系统性地评估策略表现、发现潜在弱点，并为最终的实盘决策提供数据支持。

---

## 阶段一：准备与环境设置 (Preparation & Setup)

此阶段的目标是确保我们拥有高质量的数据、可复现的测试环境和明确的成功标准。

### 1. 数据准备
- **数据源**: 确保 `src/data_collection/downData.py` 脚本可以稳定地从目标交易所（如 Binance）获取高质量的K线数据。
- **时间周期**: 下载策略所需的全部时间周期数据：`1d`, `4h`, `1h`。
- **历史深度**: 获取至少3-5年的历史数据，以覆盖多种市场状况（牛市、熊市、震荡市）。
- **交易对**: 准备至少三个核心交易对的数据，例如 `BTCUSDT`, `ETHUSDT`, 以及一个波动性较大的主流山寨币，以测试策略的普适性。

### 2. 环境与配置
- **回测脚本**: 创建一个主回测脚本，例如 `run_backtest.py`。该脚本应能：
    - 加载指定的策略配置 (`StrategyConfig`)。
    - 加载历史数据文件。
    - 调用 `src/backtest/engine.py` 来执行回测。
    - 保存详细的回测结果（交易日志、绩效指标）到独立的输出文件（如CSV或JSON）。
- **配置管理**: 为每一组测试创建一个独立的配置文件或在脚本中动态生成配置。**避免直接修改 `strategies/config.py`**，以保证测试的可复现性。

### 3. 绩效评估指标 (KPIs)
- **核心指标**: 确定我们用来衡量策略成功与否的关键指标。`src/backtest/performance.py` 模块应至少能计算以下内容：
    - **总回报率 (Total Return)**
    - **夏普比率 (Sharpe Ratio)**: 衡量风险调整后回报的核心指标。
    - **最大回撤 (Max Drawdown)**: 衡量策略可能面临的最大资金亏损，是风险控制的关键。
    - **胜率 (Win Rate)**
    - **盈亏比 (Profit/Loss Ratio)**
    - **交易次数 (Total Trades)**

---

## 阶段二：历史数据回测 (Historical Backtesting)

此阶段旨在通过历史数据，系统性地评估策略在不同参数和市场环境下的表现。

### 1. 基准测试 (Baseline Test)
- **目的**: 建立一个性能基准。
- **操作**: 使用 `standard` 标准模式配置，在 `BTCUSDT` 的完整历史数据上运行一次回测。记录下所有绩效指标，作为后续所有优化的比较对象。

### 2. 参数敏感性分析 (Parameter Sensitivity)
- **目的**: 测试策略对关键参数变化的敏感程度，避免参数过拟合。
- **操作**: 每次只改变一个参数，进行一系列回测：
    - **止损倍率**: 测试不同的 `stop_loss_multiplier` (例如从1.5到3.0，步长0.5)。
    - **KDJ/MACD周期**: 小幅调整核心指标的计算周期，观察其对结果的影响。
    - **信号强度阈值**: 调整 `generate_trading_signal` 中的交易触发强度阈值（当前为0.6），观察交易次数和胜率的变化。
- **分析**: 寻找那些即使参数在一定范围内变动，策略表现依然稳健的“参数平原”。

### 3. 鲁棒性检验 (Robustness Check)
- **目的**: 确保策略的有效性不是偶然的，能适应不同环境。
- **操作**:
    - **不同市场周期**: 将历史数据切分为明显的牛市、熊市和震荡市三个阶段，分别进行回测，评估策略在不同市场风格下的表现。
    - **不同交易对**: 使用相同的 `standard` 配置，在 `ETHUSDT` 和另一个山寨币上运行回测，检验策略的通用性。

---

## 阶段三：前向测试 / 模拟交易 (Forward Testing / Paper Trading)

此阶段旨在模拟真实交易环境，检验策略在实时数据流下的表现，并暴露历史回测中无法发现的问题（如延迟、API错误等）。

### 1. 系统搭建
- **实时数据流**: 对接交易所的实时WebSocket数据流，以获取最新的K线更新。
- **任务调度**: 使用定时任务调度器（如 `APScheduler` 或系统 `cron`），在每个K线周期结束时（如每小时整点）触发策略的 `analyze_market` 方法。
- **模拟账户**: 使用 `src/backtest/portfolio.py` 模块来模拟账户资金、持仓和订单执行。当策略生成交易信号时，由 `Portfolio` 模块记录这笔“虚拟”交易。

### 2. 执行与监控
- **运行周期**: 至少进行 **1个月** 的不间断模拟交易。
- **日志记录**: 记录所有生成的信号、执行的（模拟）交易、遇到的任何系统错误或API问题。
- **一致性对比**: 定期（如每周）将模拟交易的绩效与同一时期的历史回测结果进行比较。如果出现显著偏差，需要深入调查原因。

---

## 阶段四：结果分析与迭代

- **数据汇总**: 将所有回测和模拟交易的结果汇总到一张总表中。
- **可视化分析**: 绘制关键图表，如：
    - **权益曲线 (Equity Curve)**: 直观展示策略的长期盈利能力。
    - **回撤图 (Drawdown Chart)**: 分析策略的风险暴露情况。
    - **参数热力图**: 用于敏感性分析，直观地找到最佳参数区间。
- **策略迭代**: 根据分析结果，识别策略的弱点（例如，在震荡市中表现不佳）。提出改进假设（例如，增加一个趋势过滤器ADX），然后返回**阶段二**，用新的策略版本进行回测，形成一个完整的优化闭环。

## 最终决策

只有当策略在历史回测中表现稳健、在模拟交易中结果一致，并且您对其风险和回报特性有充分理解后，才能考虑进入小资金实盘交易阶段。
